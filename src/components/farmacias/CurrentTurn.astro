---
import { supabase } from "../../lib/supabase";
import PharmacyCard from "./PharmacyCard.astro";

const now = new Date().toISOString();

const { data: pharmacies, error } = await supabase
  .from("pharmacy_turns")
  .select(
    `
    starts_at,
    ends_at,
    businesses!inner (
      id,
      name,
      address,
      phone,
      whatsapp
    )
  `
  )
  .lte("starts_at", now)
  .gt("ends_at", now);

if (error) {
  console.error("Error farmacias de turno:", error);
}

const hasTurns = pharmacies && pharmacies.length > 0;
---

<section>
  <div class="mb-6 flex items-center justify-between">
    <h2 class="text-2xl font-bold">Accesos RÃ¡pidos</h2>
  </div>

  <div class="grid gap-6 md:grid-cols-3">
    {
      hasTurns ? (
        pharmacies.map((turn) => {
          const business = Array.isArray(turn.businesses)
            ? turn.businesses[0]
            : turn.businesses;

          return (
            <PharmacyCard
              name={business.name}
              address={business.address}
              badge="ğŸŸ¢ De turno ahora"
              subtitle="Hoy Â· hasta las 8 hs"
              phone={business.phone}
              whatsapp={business.whatsapp}
              highlight
            />
          );
        })
      ) : (
        <div class="rounded-2xl bg-gray-50 p-6 text-center text-gray-500">
          No hay farmacias de turno en este momento.
        </div>
      )
    }
  </div>
</section>
