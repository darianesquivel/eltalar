---
import { supabase } from "../../lib/supabase";
import PharmacyCard from "./PharmacyCard.astro";

const now = new Date().toISOString();

const { data: nextTurns, error } = await supabase
  .from("pharmacy_turns")
  .select(
    `
    starts_at,
    businesses!inner (
      name,
      address,
      phone
    )
  `
  )
  .gt("starts_at", now)
  .order("starts_at", { ascending: true })
  .limit(6);

if (error) {
  console.error("Error pr√≥ximos turnos:", error);
}

const formatDay = (date: string) =>
  new Date(date).toLocaleDateString("es-AR", { weekday: "long" }).toUpperCase();

const formatDate = (date: string) =>
  new Date(date).toLocaleDateString("es-AR", { day: "numeric" });

const hasTurns = nextTurns && nextTurns.length > 0;
---

<section>
  <div class="mb-6 flex items-center justify-between">
    <h2 class="text-2xl font-bold">Pr√≥ximos Turnos</h2>
  </div>

  {
    hasTurns ? (
      <div class="grid gap-6 md:grid-cols-3">
        {nextTurns.map((turn) => {
          const business = Array.isArray(turn.businesses)
            ? turn.businesses[0]
            : turn.businesses;

          return (
            <PharmacyCard
              name={business.name}
              address={business.address}
              badge={`üìÖ ${formatDay(turn.starts_at)} ${formatDate(
                turn.starts_at
              )}`}
            />
          );
        })}
      </div>
    ) : (
      <div class="rounded-2xl bg-gray-50 p-6 text-center text-gray-500">
        No hay turnos pr√≥ximos cargados.
      </div>
    )
  }
</section>
