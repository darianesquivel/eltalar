---
import BusinessCard from "./BusinessCard.astro";
import { supabase } from "../../lib/supabase";
import { getBusinessStatus } from "../../lib/businessHours";

const url = new URL(Astro.request.url);
const activeCategory = url.searchParams.get("categoria");
const searchQuery = url.searchParams.get("buscar");

let categoryId = null;

/* 1️⃣ Categoría por filtro explícito */
if (activeCategory) {
  const { data } = await supabase
    .from("categories")
    .select("id")
    .eq("slug", activeCategory)
    .single();

  categoryId = data?.id ?? null;
}

/* 2️⃣ Categoría detectada por buscador */
let searchCategoryId = null;

if (!categoryId && searchQuery) {
  const { data } = await supabase
    .from("categories")
    .select("id")
    .or(`name.ilike.%${searchQuery}%,slug.ilike.%${searchQuery}%`)
    .single();

  searchCategoryId = data?.id ?? null;
}

/* 3️⃣ Query base */
let query = supabase
  .from("businesses")
  .select(
    `
    *,
    categories (
      id,
      name,
      slug
    ),
    business_hours (
      day_of_week,
      open_time,
      close_time,
      is_closed
    )
  `
  )
  .eq("is_active", true)
  .order("priority", { ascending: false });

/* 4️⃣ Aplicar filtros */
if (categoryId || searchCategoryId) {
  query = query.eq("category_id", categoryId ?? searchCategoryId);
} else if (searchQuery) {
  query = query.or(
    `name.ilike.%${searchQuery}%,description.ilike.%${searchQuery}%`
  );
}

/* 5️⃣ Ejecutar */
const { data: businesses, error } = await query;
if (error) console.error(error);

/* 6️⃣ Estado abierto/cerrado */
const businessesWithStatus = businesses?.map((business) => {
  const status = getBusinessStatus(business.business_hours ?? []);

  return {
    ...business,
    is_open: status.is_open,
    status_label: status.label,
  };
});
---

<div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
  {
    businessesWithStatus && businessesWithStatus.length > 0 ? (
      businessesWithStatus.map((business) => (
        <BusinessCard business={business} />
      ))
    ) : (
      <div class="col-span-full py-12 text-center text-gray-500">
        No se encontraron comercios con esos filtros.
      </div>
    )
  }
</div>
